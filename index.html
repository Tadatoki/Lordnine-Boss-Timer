<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lord Nine Field Boss Timer</title>
  <style>
:root {
  --bg: #0f1724;
  --card: #0b1220;
  --muted: #9aa6b2;
  --accent: #7dd3fc;
}
html, body {
  height: 100%;
  margin: 0;
  font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
  background: linear-gradient(180deg, #071029 0%, #0e1724 100%);
  color: #e6eef6;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  padding: 16px;
  overflow: hidden;
  animation: fadeInBody 0.5s ease forwards;
}
@keyframes fadeInBody { from { opacity: 0; transform: translateY(8px);} to {opacity:1; transform:translateY(0);} }
.wrap { width: 100%; max-width: 1200px; display:flex; flex-direction:column; height:100%; overflow:auto; }

/* sticky header */
header {
  display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px;
  margin-bottom:12px; position:sticky; top:0;
  background: rgba(15,23,36,0.9); backdrop-filter: blur(6px);
  padding:8px 12px; border-radius:10px; z-index:100;
}
h1 { font-size: clamp(20px,2.2vw,28px); margin:0; }
.controls { display:flex; flex-wrap:wrap; gap:8px; }
button {
  background:transparent; border:1px solid rgba(255,255,255,0.06); padding:8px 12px; border-radius:8px;
  color:inherit; cursor:pointer; font-size:clamp(12px,1.3vw,14px);
  transition: background .2s ease, transform .12s ease;
}
button:hover { background: rgba(255,255,255,0.06); transform: translateY(-1px); }

/* layout */
.grid { display:grid; grid-template-columns: 2fr 1fr; gap:16px; flex:1; min-height:0; overflow:visible; }

/* Make boss and timer cards equal height */
.grid {
  align-items: stretch;
}

.grid > .card {
  display: flex;
  flex-direction: column;
  height: 100%;
}
.card {
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border-radius:12px; border:1px solid rgba(255,255,255,0.03);
  display:flex; flex-direction:column; padding:12px; min-height:0; overflow:visible; height:100%;
}
.card h3 { margin:0 0 6px; font-size:clamp(16px,1.8vw,20px); }

/* boss list & timers */
.boss-list { display:grid; grid-template-columns: repeat(auto-fill,minmax(280px,1fr)); gap:8px; overflow-y:auto; flex:1; padding-right:4px; max-height: calc(100vh - 220px); }
.timers {
  display: flex;
  flex-direction: column;
  gap: 8px;
  overflow-y: auto;
  padding-right: 4px;
  max-height: calc(100vh - 220px);
}

.card:has(#timers) {
  display: flex;
  flex-direction: column;
  height: 100%;
}

.card:has(#timers) footer {
  flex-shrink: 0;
  margin-top: auto;
}

/* boss row */
.boss {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px;
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.02);
  gap: 12px;
  flex-wrap: wrap;
  min-width: 0;
}
@keyframes fadeInItem { to { opacity:1; transform: translateY(0); } }
.boss .meta {
  display: flex;
  flex-direction: column;
  flex: 1;
  min-width: 180px;
  max-width: 100%;
  overflow: hidden;
}

.boss .name,
.boss .sub {
  display: inline-block;
  white-space: nowrap;
  overflow: visible;
  text-overflow: unset;
  word-break: keep-all;
}

.boss .name {
  font-weight: 600;
  font-size: clamp(13px, 1.4vw, 15px);
}

.boss .sub {
  font-size: clamp(11px, 1.1vw, 13px);
  color: var(--muted);
}
.boss .buttons {
  display: flex;
  justify-content: flex-end;
  gap: 6px;
  flex-shrink: 0;
  flex-wrap: wrap;
  min-width: 140px;
}
.boss button {
  flex: 1 1 auto;
  padding: 6px 8px;
  min-width: 70px;
  font-size: 13px;
  border-radius: 6px;
  border: 1px solid rgba(255,255,255,0.08);
  background: rgba(255,255,255,0.03);
}
.boss button:hover { background: rgba(255,255,255,0.08); }
.boss .killBtn.active { border-color:var(--accent); box-shadow:0 0 10px var(--accent); color:var(--accent); }

/* timer row */
.timer { display:flex; align-items:center; justify-content:space-between; padding:10px; border-radius:8px; background: rgba(0,0,0,0.2); min-width:0; gap:8px; }
.timer.ready { border:1px solid var(--accent); color:var(--accent); animation: pulseGlow 1.8s ease-in-out infinite; }
@keyframes pulseGlow { 0%{box-shadow:0 0 6px rgba(125,211,252,0.35);}50%{box-shadow:0 0 16px rgba(125,211,252,0.8);}100%{box-shadow:0 0 6px rgba(125,211,252,0.35);} }

/* sticky next boss */
.next { font-size:clamp(14px,1.8vw,18px); color:var(--accent); position:sticky; top:0; background: rgba(11,18,32,0.9); backdrop-filter: blur(4px); padding:6px 10px; border-radius:8px; z-index:50; }

/* footer */
footer { margin-top:12px; color:var(--muted); font-size:clamp(11px,1.2vw,13px); text-align:center; }

/* responsive */
@media (max-width:900px) { .grid { grid-template-columns: 1fr; }

/* Make boss and timer cards equal height */
.grid {
  align-items: stretch;
}

.grid > .card {
  display: flex;
  flex-direction: column;
  height: 100%;
} .boss-list { grid-template-columns: 1fr; } }
@media (max-width:600px) { body { padding:8px; } .controls { justify-content:center; } button { padding:6px 10px; } }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>[DFck]Lord Nine ‚Äî Boss Timers</h1>
      <div class="controls">
        <button id="resetAll">Reset All Timers</button>
        <button id="exportBtn">Export JSON</button>
        <button id="setWebhook">Set Webhook URL</button>
        <button id="testWebhook">Test Webhook</button>
      </div>
    </header>

    <div class="grid">
      <div class="card">
        <h3>Bosses</h3>
        <p style="color:var(--muted);margin-top:4px">Mark it dead ‚Äî or set a custom killed time.</p>
        <div class="boss-list" id="bossList"></div>
		<footer>Created by: [DFck]Tadatokichi</footer>
      </div>

      <div class="card">
        <h3>Active Timers</h3>
        <div style="margin:8px 0" class="next">Next Boss: <span id="nextBoss">Calculating...</span></div>
        <div class="timers" id="timers"></div>        
      </div>
    </div>
  </div>

  <!-- Manual Kill Time Modal -->
  <div id="timeModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:1000;">
    <div style="background:#0b1220; padding:20px; border-radius:12px; width:320px; color:#e6eef6; box-shadow:0 0 20px rgba(0,0,0,0.4);">
      <h3 style="margin-top:0; font-size:18px;">Set Killed Time</h3>
      <p id="modalBossName" style="font-size:14px; color:var(--muted); margin-bottom:8px;"></p>
      <input type="datetime-local" id="killTimeInput" style="width:100%; padding:8px; border-radius:6px; border:1px solid rgba(255,255,255,0.1); background:#0f1724; color:#e6eef6;">
      <div style="margin-top:12px; display:flex; justify-content:flex-end; gap:8px;">
        <button id="cancelTimeBtn" style="padding:6px 10px;">Cancel</button>
        <button id="saveTimeBtn" style="padding:6px 10px;">Save</button>
      </div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const STORAGE_KEY = 'ln_boss_timers_v2';
  const WEBHOOK_KEY = 'ln_discord_webhook';
  let timers = loadTimers();
  let webhookUrl = localStorage.getItem(WEBHOOK_KEY) || '';

  const bossListEl = document.getElementById('bossList');
  const timersEl = document.getElementById('timers');
  const nextBossEl = document.getElementById('nextBoss');
  const resetAllBtn = document.getElementById('resetAll');
  const exportBtn = document.getElementById('exportBtn');
  const setWebhookBtn = document.getElementById('setWebhook');
  const testWebhookBtn = document.getElementById('testWebhook');

  const BOSSES = [
    { id: 'Venatus', name: 'Venatus', respawn: 60*60*10 },
    { id: 'Viorent', name: 'Viorent', respawn: 60*60*10 },
    { id: 'Ego', name: 'Ego', respawn: 60*60*21 },
    { id: 'Clemantis', name: 'Clemantis', weeklyRespawns: [{ day:1, hour:12, minute:30 }, { day:4, hour:20, minute:0 }] },
    { id: 'Livera', name: 'Livera', respawn: 60*60*24 },
    { id: 'Araneo', name: 'Araneo', respawn: 60*60*24 },
    { id: 'Undomiel', name: 'Undomiel', respawn: 60*60*24 },
    { id: 'Saphirus', name: 'Saphirus', weeklyRespawns: [{ day:0, hour:18, minute:0 }, { day:2, hour:12, minute:30 }] },
    { id: 'Neutro', name: 'Neutro', weeklyRespawns: [{ day:2, hour:20, minute:0 }, { day:4, hour:12, minute:30 }] },
    { id: 'Lady Dalia', name: 'Lady Dalia', respawn: 60*60*18 },
    { id: 'General Aquleus', name: 'General Aquleus', respawn: 60*60*29 },
    { id: 'Thymele', name: 'Thymele', weeklyRespawns: [{ day:1, hour:20, minute:0 }, { day:3, hour:12, minute:30 }] },
    { id: 'Amentis', name: 'Amentis', respawn: 60*60*29 },
    { id: 'Baron Braudmore', name: 'Baron Braudmore', respawn: 60*60*32 },
    { id: 'Milavy', name: 'Milavy', weeklyRespawns: [{ day:6, hour:16, minute:0 }] },
    { id: 'Wannitas', name: 'Wannitas', respawn: 60*60*48 },
    { id: 'Metus', name: 'Metus', respawn: 60*60*48 },
    { id: 'Duplican', name: 'Duplican', respawn: 60*60*48 },
    { id: 'Shuliar', name: 'Shuliar', respawn: 60*60*35 },
    { id: 'Ringor', name: 'Ringor', weeklyRespawns: [{ day:6, hour:18, minute:0 }] },
    { id: 'Roderick', name: 'Roderick', weeklyRespawns: [{ day:5, hour:20, minute:0 }] },
    { id: 'Gareth', name: 'Gareth', respawn: 60*60*32 },
    { id: 'Titore', name: 'Titore', respawn: 60*60*37 },
    { id: 'Larba', name: 'Larba', respawn: 60*60*35 },
    { id: 'Auraq', name: 'Auraq', weeklyRespawns: [{ day:5, hour:23, minute:0 }, { day:3, hour:22, minute:0 }] },
    { id: 'Secreta', name: 'Secreta', respawn: 60*60*62 },
    { id: 'Ordo', name: 'Ordo', respawn: 60*60*62 },
    { id: 'Asta', name: 'Asta', respawn: 60*60*62 },
    { id: 'Supore', name: 'Supore', respawn: 60*60*62 },
    { id: 'Chaiflock', name: 'Chaiflock', weeklyRespawns: [{ day:6, hour:23, minute:0 }] },
    { id: 'Benji', name: 'Benji', weeklyRespawns: [{ day:0, hour:22, minute:0 }] }
  ];

  function formatSec(s){
    if (s <= 0) return 'Ready';
    const d = Math.floor(s/86400); s %= 86400;
    const h = Math.floor(s/3600); s %= 3600;
    const m = Math.floor(s/60); const sec = s%60;
    if (d>0) return `${d}d ${String(h).padStart(2,'0')}h`;
    if (h>0) return `${h}h ${String(m).padStart(2,'0')}m`;
    return `${String(m).padStart(2,'0')}m ${String(sec).padStart(2,'0')}s`;
  }

  function loadTimers(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; } catch(e) { return {}; } }
  function saveTimers(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(timers)); }

  async function sendToDiscord(message){
    if (!webhookUrl) return;
    try {
      await fetch(webhookUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: message })
      });
    } catch(err) {
      console.warn('Discord webhook failed:', err);
    }
  }

  function getNextWeeklyRespawn(respawns) {
    const now = new Date();
    let soonest = null;
    for (const { day, hour, minute } of respawns) {
      const target = new Date(now);
      target.setHours(hour, minute, 0, 0);
      target.setDate(now.getDate() + ((day + 7 - now.getDay()) % 7));
      if (target <= now) target.setDate(target.getDate() + 7);
      if (!soonest || target < soonest) soonest = target;
    }
    return soonest ? soonest.getTime() : now.getTime();
  }

  function startTimer(bossId) {
    const boss = BOSSES.find(b => b.id === bossId);
    if (!boss) return;
    const now = Date.now();
    let endTime;
    if (boss.weeklyRespawns) {
      endTime = getNextWeeklyRespawn(boss.weeklyRespawns);
      timers[bossId] = { endTime, startedAt: now, weekly: true };
    } else {
      endTime = now + boss.respawn * 1000;
      timers[bossId] = { endTime, startedAt: now };
    }
    saveTimers();
    renderAll();
    const respawnTime = new Date(endTime).toLocaleString();
    sendToDiscord(`@everyone \n‚öîÔ∏è **${boss.name}** defeated!\nRespawn expected at **${respawnTime}**.`);
  }

  function clearTimer(bossId) {
    delete timers[bossId];
    saveTimers();
    renderAll();
  }

  function resetAll(){ timers = {}; saveTimers(); renderAll(); }

  // --- Manual time modal
  let currentBossForTime = null;
  function openTimeModal(bossId) {
    const boss = BOSSES.find(b => b.id === bossId);
    if (!boss) return;
    currentBossForTime = boss;
    document.getElementById('modalBossName').textContent = boss.name;
    document.getElementById('killTimeInput').value = '';
    document.getElementById('timeModal').style.display = 'flex';
  }
  function closeTimeModal() {
    document.getElementById('timeModal').style.display = 'none';
    currentBossForTime = null;
  }
  document.getElementById('cancelTimeBtn').addEventListener('click', closeTimeModal);
  document.getElementById('saveTimeBtn').addEventListener('click', () => {
    const input = document.getElementById('killTimeInput').value;
    if (!input || !currentBossForTime) return;
    const parsed = new Date(input);
    if (isNaN(parsed)) { alert('Invalid date/time'); return; }
    const killedAt = parsed.getTime();
    const boss = currentBossForTime;
    let endTime;
    if (boss.weeklyRespawns) {
      endTime = getNextWeeklyRespawn(boss.weeklyRespawns);
      // make sure next weekly respawn after killedAt
      while (endTime <= killedAt) {
        // advance by one week by creating a fake now at killedAt + 1ms
        const fakeNow = new Date(killedAt + 1);
        let soonest = null;
        for (const { day, hour, minute } of boss.weeklyRespawns) {
          const target = new Date(fakeNow);
          target.setHours(hour, minute, 0, 0);
          target.setDate(fakeNow.getDate() + ((day + 7 - fakeNow.getDay()) % 7));
          if (target <= fakeNow) target.setDate(target.getDate() + 7);
          if (!soonest || target < soonest) soonest = target;
        }
        endTime = soonest ? soonest.getTime() : killedAt;
        // if still <= killedAt, add 7 days
        if (endTime <= killedAt) endTime += 7*24*60*60*1000;
        break;
      }
      timers[boss.id] = { endTime, startedAt: killedAt, weekly: true, notifiedSoon: false };
    } else {
      endTime = killedAt + boss.respawn * 1000;
      timers[boss.id] = { endTime, startedAt: killedAt, notifiedSoon: false };
    }
    saveTimers();
    renderAll();
    closeTimeModal();
    sendToDiscord(`@everyone \n‚öîÔ∏è **${boss.name}** manually set.\nRespawn expected at **${new Date(endTime).toLocaleString()}**.`);
  });

  // --- Render functions
  function renderBossList() {
    bossListEl.innerHTML = '';
    for (const b of BOSSES) {
      const isActive = timers[b.id] && timers[b.id].endTime > Date.now();
      const node = document.createElement('div');
      node.className = 'boss';
      node.innerHTML = `
        <div class="meta">
          <div class="name">${b.name}</div>
          <div class="sub">Respawn: ${
            b.weeklyRespawns
              ? b.weeklyRespawns.map(r => `${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][r.day]} ${String(r.hour).padStart(2,'0')}:${String(r.minute).padStart(2,'0')}`).join(', ')
              : (b.respawn / 3600) + ' hr'
          }</div>
        </div>
        <div class="buttons">
          <button data-id="${b.id}" class="killBtn ${isActive ? 'active' : ''}">${isActive ? 'Killed' : 'Mark Dead'}</button>
          <button data-id="${b.id}" class="setTimeBtn">Set Time</button>
          
        </div>
      `;
      bossListEl.appendChild(node);
    }
    bossListEl.querySelectorAll('.killBtn').forEach(btn => btn.addEventListener('click', e => startTimer(e.currentTarget.dataset.id)));
    bossListEl.querySelectorAll('.clearBtn').forEach(btn => btn.addEventListener('click', e => clearTimer(e.currentTarget.dataset.id)));
    bossListEl.querySelectorAll('.setTimeBtn').forEach(btn => btn.addEventListener('click', e => openTimeModal(e.currentTarget.dataset.id)));
  }

  function renderTimers() {
    timersEl.innerHTML = '';
    const entries = Object.entries(timers).map(([id, info]) => ({ id, info, boss: BOSSES.find(b => b.id === id) }))
      .filter(x => x.boss)
      .sort((a,b) => a.info.endTime - b.info.endTime);

    if (entries.length === 0) {
      timersEl.innerHTML = '<div style="color:var(--muted)">No active timers</div>';
      return;
    }

    for (const e of entries) {
      const remainingSec = Math.round((e.info.endTime - Date.now()) / 1000);
      const remaining = Math.max(0, remainingSec);
      const node = document.createElement('div');
      node.className = 'timer' + (remaining === 0 ? ' ready' : '');
      node.innerHTML = `
        <div>
          <div style="font-weight:600">${e.boss.name}</div>
          <div style="font-size:12px;color:var(--muted)">Spawn: ${new Date(e.info.endTime).toLocaleString()}</div>
        </div>
        <div>
          <div style="font-weight:700">${formatSec(remaining)}</div>
          <div style="display:flex;gap:6px;margin-top:6px;justify-content:flex-end">
            <button data-id="${e.id}" class="clearBtnSmall">Clear</button>
          </div>
        </div>
      `;
      timersEl.appendChild(node);
    }

    timersEl.querySelectorAll('.clearBtnSmall').forEach(btn => btn.addEventListener('click', e => clearTimer(e.currentTarget.dataset.id)));
  }

  function computeNextBoss() {
    const upcoming = Object.entries(timers)
      .map(([id, info]) => ({ id, endTime: info.endTime, boss: BOSSES.find(b => b.id === id) }))
      .filter(x => x.boss)
      .sort((a,b) => a.endTime - b.endTime);
    if (upcoming.length === 0) {
      nextBossEl.textContent = 'Calculating...';
      return;
    }
    const soon = upcoming[0];
    const seconds = Math.round((soon.endTime - Date.now()) / 1000);
    nextBossEl.textContent = `${soon.boss.name} in ${formatSec(Math.max(0, seconds))}`;
  }

  function renderAll() {
    renderBossList();
    renderTimers();
    computeNextBoss();
  }

  // --- Timer loop: update countdowns only
setInterval(() => {
  const now = Date.now();
  let changed = false;

  for (const id of Object.keys(timers)) {
    const info = timers[id];
    const boss = BOSSES.find(b => b.id === id);
    if (!boss) continue;
    const remainingMs = info.endTime - now;

    // 5-minute warning
    if (remainingMs <= 5 * 60 * 1000 && remainingMs > 0 && !info.notifiedSoon) {
      const respawnTime = new Date(info.endTime).toLocaleString();
      sendToDiscord(`@here \n‚è≥ **${boss.name}** will respawn in 5 minutes!\nExpected at **${respawnTime}**.`);
      info.notifiedSoon = true;
      changed = true;
    }

    // Respawn reached
    if (info.endTime <= now) {
      const respawnTime = new Date(info.endTime).toLocaleString();
      sendToDiscord(`@everyone \nüïí **${boss.name}** has respawned!\n(Respawn time: **${respawnTime}**)`);
      if (boss.weeklyRespawns) {
        const nextTime = getNextWeeklyRespawn(boss.weeklyRespawns);
        timers[id] = { endTime: nextTime, startedAt: now, weekly: true, notifiedSoon: false };
      } else {
        const nextTime = now + boss.respawn * 1000 + 5 * 60 * 1000; // add buffer
        timers[id] = { endTime: nextTime, startedAt: now, notifiedSoon: false };
      }
      changed = true;
    }
  }

  if (changed) saveTimers();

  // only these two need to refresh live
  renderTimers();
  computeNextBoss();
}, 1000);


  // --- Controls: reset/export/webhook/test
  resetAllBtn.addEventListener('click', () => { if (confirm('Reset all timers?')) resetAll(); });

  exportBtn.addEventListener('click', () => {
    const data = JSON.stringify(timers, null, 2);
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'boss_timers.json'; a.click(); URL.revokeObjectURL(url);
  });

  setWebhookBtn.addEventListener('click', () => {
    const url = prompt('Enter your Discord Webhook URL:', webhookUrl || '');
    if (url) {
      webhookUrl = url.trim();
      localStorage.setItem(WEBHOOK_KEY, webhookUrl);
      alert('Webhook URL saved!');
    }
  });

  testWebhookBtn.addEventListener('click', async () => {
    if (!webhookUrl) { alert('No webhook set yet!'); return; }
    await sendToDiscord('‚úÖ Test sage from **Lord Nine Boss Timer** ‚Äî webhook working!');
    alert('Test message sent to Discord!');
  });

  
  // --- Auto-activate weekly spawn bosses ---
  for (const boss of BOSSES) {
    if (boss.weeklyRespawns && !timers[boss.id]) {
      const nextTime = getNextWeeklyRespawn(boss.weeklyRespawns);
      timers[boss.id] = { endTime: nextTime, startedAt: Date.now(), weekly: true, notifiedSoon: false };
    }
  }
  saveTimers();

  // Initialize render
  renderAll();

  // Utility: clear timers on unload? (not needed) ‚Äî just keep localStorage.

}); // DOMContentLoaded end
</script>
</body>
</html>
